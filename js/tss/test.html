<!DOCTYPE html>
<html>
<head>
    <title>UnitTest for T'Sound System for JavaScript (web Audio API)</title>
    <!-- range type input tag emulation for Firefox -->
    <script language="JavaScript" src="https://github.com/fryn/html5slider/raw/master/html5slider.js"></script>
    <!-- include components -->
    <script language="JavaScript" src="../Log.js"></script>
    <script language="JavaScript" src="AudioLooper.js"></script>
    <script language="JavaScript" src="MasterChannel.js"></script>
    <script language="JavaScript" src="SimpleSlaveChannel.js"></script>
    <script language="JavaScript" src="PsgDeviceChannel.js"></script>
    <script language="JavaScript" src="PsglogPlayer.js"></script>
    <!-- control callback scripts -->
    <script language="JavaScript">
        function test1start() {
            Log.getLog().info("TEST1 START");
            looper.setChannel(master1);
            test = 1;
        }
        function testxstop() {
            if (0 != test) {
                Log.getLog().info("TEST" + test + " STOP");
                looper.setChannel(null);
                test = 0;
            }
        }
        function test2change(value) {
            if (2 != test) {
                Log.getLog().info("TEST2 START");
                looper.setChannel(master2);
                test = 2;
            }
            simplex.freq = value;
            var hz = document.getElementById("test2hz");
            hz.firstChild.nodeValue = value + " Hz";
        }
        function test3start() {
            if (!xh_res3) {
                Log.getLog().warn("XHR3 not ready");
                return;
            }
            Log.getLog().info("TEST3 START");
            player3.play(xh_req3.response);
            looper.setChannel(master3);
            test = 3;
        }
    </script>
</head>
<body>
<hr>
<pre>Play 440Hz/550Hz/660Hz</pre>
<button onclick="test1start()">START</button>
<button onclick="testxstop()">STOP</button>
<hr>
<pre>Play with slider</pre>
<input type="range" min="1" max="4096" value="440" style="width: 100%" onchange="test2change(value)">
<pre id="test2hz">440 Hz</pre>
<hr>
<pre>PSG Log REPLAY</pre>
<button onclick="test3start()">START</button>
<button onclick="testxstop()">STOP</button>
<hr>
<div id="log"></div>
<script language="JavaScript">
    Log.setLog(new Log("log"));
    var test = 0;
    var looper = new AudioLooper();

    var master1 = new MasterChannel();
    var simple1 = new SimpleSlaveChannel(440);
    var simple2 = new SimpleSlaveChannel(550);
    var simple3 = new SimpleSlaveChannel(660);
    master1.addChannel(simple1);
    master1.addChannel(simple2);
    master1.addChannel(simple3);

    var master2 = new MasterChannel();
    var simplex = new SimpleSlaveChannel(440);
    master2.addChannel(simplex);

    var xh_res3 = false;
    var xh_req3 = new XMLHttpRequest();
    xh_req3.open("get", "../../data/psglog.1", true);
    xh_req3.responseType = "arraybuffer";
    xh_req3.onload = function () {
        Log.getLog().info("TEST3 XHR done.");
        if (xh_req3.response instanceof ArrayBuffer) {
            Log.getLog().info("  as ArrayBuffer.");
        }
        xh_res3 = true;
    };
    xh_req3.send();
    var master3 = new MasterChannel();
    var player3 = new PsglogPlayer();
    player3.setMasterChannel(master3);
</script>
</body>
</html>
